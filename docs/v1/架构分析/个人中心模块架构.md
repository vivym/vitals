# 个人中心模块架构设计

## 1. 模块概述

### 1.1 功能描述
个人中心模块提供用户账户管理、设备绑定、服务管理、设置配置等功能，是用户管理个人信息和应用设置的统一入口。

### 1.2 核心功能
- **用户信息管理**: 头像、姓名、个人资料展示和编辑
- **就诊人管理**: 患者信息的增删改查
- **智能设备管理**: 第三方健康设备的授权和解绑
- **我的服务**: 服务订阅、历史记录查看
- **专项评估**: 健康评估问卷和结果
- **用药提醒**: 用药计划的设置和管理
- **个人设置**: 应用偏好、通知设置、隐私配置
- **收藏和反馈**: 内容收藏、问题反馈

### 1.3 技术要求
- 基于 TDD 开发模式
- 支持文件上传（头像）
- 集成第三方SDK（华为运动健康等）
- 本地通知和提醒功能
- 数据加密和隐私保护

## 2. 数据模型设计

### 2.1 核心实体模型

```dart
// 用户资料（扩展基础User模型）
@freezed
class UserProfile with _$UserProfile {
  const factory UserProfile({
    required String id,
    required String name,
    required String phone,
    String? email,
    String? avatarUrl,
    Gender? gender,
    DateTime? birthDate,
    String? address,
    String? emergencyContact,
    String? emergencyContactPhone,
    @JsonKey(name: 'created_at') DateTime? createdAt,
    @JsonKey(name: 'updated_at') DateTime? updatedAt,
  }) = _UserProfile;

  factory UserProfile.fromJson(Map<String, dynamic> json) =>
      _$UserProfileFromJson(json);

  const UserProfile._();

  int? get age {
    if (birthDate == null) return null;
    final now = DateTime.now();
    int age = now.year - birthDate!.year;
    if (now.month < birthDate!.month ||
        (now.month == birthDate!.month && now.day < birthDate!.day)) {
      age--;
    }
    return age;
  }
}

// 设备绑定信息
@freezed
class ConnectedDevice with _$ConnectedDevice {
  const factory ConnectedDevice({
    required String id,
    required String name,
    required DeviceType type,
    required DeviceStatus status,
    @JsonKey(name: 'connected_at') DateTime? connectedAt,
    @JsonKey(name: 'last_sync') DateTime? lastSync,
    Map<String, dynamic>? settings,
  }) = _ConnectedDevice;

  factory ConnectedDevice.fromJson(Map<String, dynamic> json) =>
      _$ConnectedDeviceFromJson(json);
}

// 设备类型枚举
@JsonEnum(valueField: 'value')
enum DeviceType {
  huaweiHealth(1, '华为运动健康', Icons.watch),
  xiaomiHealth(2, '小米运动', Icons.fitness_center),
  appleHealth(3, 'Apple Health', Icons.favorite),
  bloodPressureMonitor(4, '血压计', Icons.monitor_heart),
  glucoseMeter(5, '血糖仪', Icons.water_drop);

  const DeviceType(this.value, this.label, this.icon);
  final int value;
  final String label;
  final IconData icon;
}

// 设备状态
@JsonEnum(valueField: 'value')
enum DeviceStatus {
  connected(1, '已连接', Colors.green),
  disconnected(2, '未连接', Colors.grey),
  syncing(3, '同步中', Colors.orange),
  error(4, '连接异常', Colors.red);

  const DeviceStatus(this.value, this.label, this.color);
  final int value;
  final String label;
  final Color color;
}

// 我的服务
@freezed
class MyService with _$MyService {
  const factory MyService({
    required String id,
    required String name,
    required String description,
    required ServiceType type,
    required ServiceStatus status,
    String? iconUrl,
    @JsonKey(name: 'subscribed_at') DateTime? subscribedAt,
    @JsonKey(name: 'expires_at') DateTime? expiresAt,
  }) = _MyService;

  factory MyService.fromJson(Map<String, dynamic> json) =>
      _$MyServiceFromJson(json);
}

// 服务类型
@JsonEnum(valueField: 'value')
enum ServiceType {
  consultation(1, '在线问诊'),
  followUp(2, '随访管理'),
  rehabilitation(3, '康复计划'),
  nutrition(4, '营养指导'),
  medication(5, '用药管理');

  const ServiceType(this.value, this.label);
  final int value;
  final String label;
}

// 服务状态
@JsonEnum(valueField: 'value')
enum ServiceStatus {
  active(1, '服务中'),
  expired(2, '已过期'),
  suspended(3, '已暂停');

  const ServiceStatus(this.value, this.label);
  final int value;
  final String label;
}

// 用药提醒
@freezed
class MedicationReminder with _$MedicationReminder {
  const factory MedicationReminder({
    required String id,
    required String patientId,
    required String medicationName,
    required String dosage,
    required List<TimeOfDay> scheduledTimes,
    required List<int> weekdays, // 1-7 表示周一到周日
    DateTime? startDate,
    DateTime? endDate,
    @Default(true) bool isActive,
    String? notes,
    @JsonKey(name: 'created_at') DateTime? createdAt,
  }) = _MedicationReminder;

  factory MedicationReminder.fromJson(Map<String, dynamic> json) =>
      _$MedicationReminderFromJson(json);

  const MedicationReminder._();

  bool get isExpired {
    if (endDate == null) return false;
    return DateTime.now().isAfter(endDate!);
  }

  List<DateTime> getNextReminders(int count) {
    // 计算接下来的提醒时间
    final now = DateTime.now();
    final reminders = <DateTime>[];

    for (int day = 0; day < 7 && reminders.length < count; day++) {
      final date = now.add(Duration(days: day));
      final weekday = date.weekday;

      if (weekdays.contains(weekday)) {
        for (final time in scheduledTimes) {
          final reminderTime = DateTime(
            date.year, date.month, date.day,
            time.hour, time.minute,
          );

          if (reminderTime.isAfter(now)) {
            reminders.add(reminderTime);
          }
        }
      }
    }

    reminders.sort();
    return reminders.take(count).toList();
  }
}

// 应用设置
@freezed
class AppSettings with _$AppSettings {
  const factory AppSettings({
    // 通知设置
    @Default(true) bool notificationsEnabled,
    @Default(true) bool medicationReminders,
    @Default(true) bool healthDataReminders,
    @Default(false) bool marketingNotifications,

    // 隐私设置
    @Default(true) bool dataSharingConsent,
    @Default(false) bool analyticsEnabled,
    @Default(true) bool crashReportingEnabled,

    // 界面设置
    @Default(ThemeMode.system) ThemeMode themeMode,
    @Default(Locale('zh', 'CN')) Locale locale,
    @Default(1.0) double fontSize,

    // 健康数据设置
    @Default(true) bool autoSyncDevices,
    @Default(TimeOfDay(hour: 8, minute: 0)) TimeOfDay reminderTime,
    @Default(7) int dataRetentionDays,
  }) = _AppSettings;

  factory AppSettings.fromJson(Map<String, dynamic> json) =>
      _$AppSettingsFromJson(json);
}

// 收藏内容
@freezed
class FavoriteItem with _$FavoriteItem {
  const factory FavoriteItem({
    required String id,
    required String contentId,
    required FavoriteType type,
    required String title,
    String? summary,
    String? imageUrl,
    @JsonKey(name: 'favorited_at') required DateTime favoritedAt,
  }) = _FavoriteItem;

  factory FavoriteItem.fromJson(Map<String, dynamic> json) =>
      _$FavoriteItemFromJson(json);
}

// 收藏类型
@JsonEnum(valueField: 'value')
enum FavoriteType {
  article(1, '文章'),
  video(2, '视频'),
  report(3, '报告');

  const FavoriteType(this.value, this.label);
  final int value;
  final String label;
}

// 反馈信息
@freezed
class FeedbackItem with _$FeedbackItem {
  const factory FeedbackItem({
    required String id,
    required FeedbackType type,
    required String title,
    required String content,
    List<String>? attachments,
    String? contactInfo,
    @Default(FeedbackStatus.pending) FeedbackStatus status,
    String? reply,
    @JsonKey(name: 'created_at') DateTime? createdAt,
    @JsonKey(name: 'replied_at') DateTime? repliedAt,
  }) = _FeedbackItem;

  factory FeedbackItem.fromJson(Map<String, dynamic> json) =>
      _$FeedbackItemFromJson(json);
}

// 反馈类型
@JsonEnum(valueField: 'value')
enum FeedbackType {
  bug(1, 'Bug反馈'),
  suggestion(2, '建议'),
  complaint(3, '投诉'),
  praise(4, '表扬'),
  other(5, '其他');

  const FeedbackType(this.value, this.label);
  final int value;
  final String label;
}

// 反馈状态
@JsonEnum(valueField: 'value')
enum FeedbackStatus {
  pending(1, '待处理'),
  processing(2, '处理中'),
  replied(3, '已回复'),
  closed(4, '已关闭');

  const FeedbackStatus(this.value, this.label);
  final int value;
  final String label;
}
```

### 2.2 状态模型

```dart
// 个人中心状态
@freezed
class ProfileState with _$ProfileState {
  const factory ProfileState({
    UserProfile? userProfile,
    @Default([]) List<Patient> patients,
    @Default([]) List<ConnectedDevice> connectedDevices,
    @Default([]) List<MyService> myServices,
    @Default([]) List<MedicationReminder> medicationReminders,
    @Default([]) List<FavoriteItem> favorites,
    AppSettings? settings,
    @Default(false) bool isLoading,
    String? error,
  }) = _ProfileState;
}

// 设备管理状态
@freezed
class DeviceManagementState with _$DeviceManagementState {
  const factory DeviceManagementState({
    @Default([]) List<ConnectedDevice> connectedDevices,
    @Default([]) List<DeviceType> availableDevices,
    @Default(false) bool isConnecting,
    String? connectingDeviceId,
    String? error,
  }) = _DeviceManagementState;
}

// 用药提醒状态
@freezed
class MedicationReminderState with _$MedicationReminderState {
  const factory MedicationReminderState({
    @Default([]) List<MedicationReminder> reminders,
    @Default([]) List<DateTime> upcomingReminders,
    @Default(false) bool isLoading,
    @Default(false) bool notificationsPermissionGranted,
    String? error,
  }) = _MedicationReminderState;
}
```

## 3. 数据层架构

### 3.1 数据源设计

```dart
// 个人中心远程数据源
abstract class ProfileRemoteDataSource {
  Future<UserProfile> getUserProfile();
  Future<UserProfile> updateUserProfile(UserProfile profile);
  Future<String> uploadAvatar(File avatarFile);

  Future<List<ConnectedDevice>> getConnectedDevices();
  Future<ConnectedDevice> connectDevice(DeviceType type, Map<String, dynamic> config);
  Future<void> disconnectDevice(String deviceId);

  Future<List<MyService>> getMyServices();
  Future<List<MedicationReminder>> getMedicationReminders(String patientId);
  Future<MedicationReminder> createMedicationReminder(MedicationReminder reminder);
  Future<void> deleteMedicationReminder(String reminderId);

  Future<List<FavoriteItem>> getFavorites();
  Future<void> addToFavorites(String contentId, FavoriteType type);
  Future<void> removeFromFavorites(String favoriteId);

  Future<void> submitFeedback(FeedbackItem feedback);
}

// Mock 实现
class ProfileRemoteDataSourceMock implements ProfileRemoteDataSource {
  @override
  Future<UserProfile> getUserProfile() async {
    await Future.delayed(const Duration(milliseconds: 500));

    return UserProfile(
      id: 'user_1',
      name: '张三',
      phone: '13800000000',
      email: 'zhangsan@example.com',
      avatarUrl: 'https://example.com/avatar.jpg',
      gender: Gender.male,
      birthDate: DateTime(1990, 5, 15),
      address: '北京市朝阳区xxx街道',
      emergencyContact: '李四',
      emergencyContactPhone: '13900000000',
      createdAt: DateTime.now().subtract(const Duration(days: 30)),
      updatedAt: DateTime.now(),
    );
  }

  @override
  Future<List<ConnectedDevice>> getConnectedDevices() async {
    await Future.delayed(const Duration(milliseconds: 600));

    return [
      ConnectedDevice(
        id: 'device_1',
        name: '华为运动健康',
        type: DeviceType.huaweiHealth,
        status: DeviceStatus.connected,
        connectedAt: DateTime.now().subtract(const Duration(days: 10)),
        lastSync: DateTime.now().subtract(const Duration(hours: 2)),
      ),
      ConnectedDevice(
        id: 'device_2',
        name: '小米手环',
        type: DeviceType.xiaomiHealth,
        status: DeviceStatus.disconnected,
        connectedAt: DateTime.now().subtract(const Duration(days: 5)),
      ),
    ];
  }

  @override
  Future<List<MedicationReminder>> getMedicationReminders(String patientId) async {
    await Future.delayed(const Duration(milliseconds: 400));

    return [
      MedicationReminder(
        id: 'reminder_1',
        patientId: patientId,
        medicationName: '降压药',
        dosage: '5mg',
        scheduledTimes: [
          const TimeOfDay(hour: 8, minute: 0),
          const TimeOfDay(hour: 20, minute: 0),
        ],
        weekdays: [1, 2, 3, 4, 5, 6, 7], // 每天
        startDate: DateTime.now().subtract(const Duration(days: 7)),
        endDate: DateTime.now().add(const Duration(days: 30)),
        isActive: true,
        notes: '饭后服用',
        createdAt: DateTime.now().subtract(const Duration(days: 7)),
      ),
    ];
  }
}

// 本地数据源
class ProfileLocalDataSourceImpl implements ProfileLocalDataSource {
  final SharedPreferences _prefs;
  final FlutterSecureStorage _secureStorage;

  @override
  Future<AppSettings?> getAppSettings() async {
    final settingsJson = _prefs.getString('app_settings');
    if (settingsJson != null) {
      return AppSettings.fromJson(jsonDecode(settingsJson));
    }
    return null;
  }

  @override
  Future<void> saveAppSettings(AppSettings settings) async {
    await _prefs.setString('app_settings', jsonEncode(settings.toJson()));
  }

  @override
  Future<UserProfile?> getCachedUserProfile() async {
    final profileJson = _prefs.getString('user_profile');
    if (profileJson != null) {
      return UserProfile.fromJson(jsonDecode(profileJson));
    }
    return null;
  }
}
```

### 3.2 仓库实现

```dart
// 个人中心仓库
class ProfileRepositoryImpl implements ProfileRepository {
  final ProfileRemoteDataSource _remoteDataSource;
  final ProfileLocalDataSource _localDataSource;

  @override
  Future<Result<UserProfile, AppError>> getUserProfile({bool forceRefresh = false}) async {
    try {
      if (!forceRefresh) {
        final cachedProfile = await _localDataSource.getCachedUserProfile();
        if (cachedProfile != null) {
          return Result.success(cachedProfile);
        }
      }

      final profile = await _remoteDataSource.getUserProfile();
      await _localDataSource.cacheUserProfile(profile);
      return Result.success(profile);
    } catch (e) {
      return Result.failure(AppError.network(message: e.toString()));
    }
  }

  @override
  Future<Result<UserProfile, AppError>> updateUserProfile(UserProfile profile) async {
    try {
      final updatedProfile = await _remoteDataSource.updateUserProfile(profile);
      await _localDataSource.cacheUserProfile(updatedProfile);
      return Result.success(updatedProfile);
    } catch (e) {
      return Result.failure(AppError.network(message: e.toString()));
    }
  }

  @override
  Future<Result<List<ConnectedDevice>, AppError>> getConnectedDevices() async {
    try {
      final devices = await _remoteDataSource.getConnectedDevices();
      return Result.success(devices);
    } catch (e) {
      return Result.failure(AppError.network(message: e.toString()));
    }
  }

  @override
  Future<Result<AppSettings, AppError>> getAppSettings() async {
    try {
      final settings = await _localDataSource.getAppSettings() ?? const AppSettings();
      return Result.success(settings);
    } catch (e) {
      return Result.failure(AppError.unknown(message: e.toString()));
    }
  }

  @override
  Future<Result<void, AppError>> saveAppSettings(AppSettings settings) async {
    try {
      await _localDataSource.saveAppSettings(settings);
      return const Result.success(null);
    } catch (e) {
      return Result.failure(AppError.unknown(message: e.toString()));
    }
  }
}
```

## 4. 业务逻辑层

### 4.1 用例定义

```dart
// 获取用户资料用例
@riverpod
class GetUserProfileUseCase extends _$GetUserProfileUseCase {
  Future<Result<UserProfile, AppError>> execute({bool forceRefresh = false}) async {
    final repository = ref.read(profileRepositoryProvider);
    return await repository.getUserProfile(forceRefresh: forceRefresh);
  }
}

// 设备连接用例
@riverpod
class ConnectDeviceUseCase extends _$ConnectDeviceUseCase {
  Future<Result<ConnectedDevice, AppError>> execute(DeviceType deviceType) async {
    final repository = ref.read(profileRepositoryProvider);

    // 根据设备类型执行不同的连接流程
    switch (deviceType) {
      case DeviceType.huaweiHealth:
        return await _connectHuaweiHealth(repository);
      case DeviceType.xiaomiHealth:
        return await _connectXiaomiHealth(repository);
      default:
        return const Result.failure(
          AppError.validation(field: 'device', message: '不支持的设备类型'),
        );
    }
  }

  Future<Result<ConnectedDevice, AppError>> _connectHuaweiHealth(
    ProfileRepository repository,
  ) async {
    try {
      // 检查权限
      final hasPermission = await _checkHealthPermission();
      if (!hasPermission) {
        return const Result.failure(
          AppError.validation(field: 'permission', message: '需要健康数据访问权限'),
        );
      }

      // 调用华为SDK进行授权
      final authResult = await _requestHuaweiHealthAuth();
      if (!authResult.success) {
        return Result.failure(
          AppError.authentication(message: authResult.error ?? '授权失败'),
        );
      }

      // 保存连接信息
      final device = await repository.connectDevice(
        DeviceType.huaweiHealth,
        {'auth_code': authResult.authCode},
      );

      return Result.success(device);
    } catch (e) {
      return Result.failure(AppError.unknown(message: e.toString()));
    }
  }

  Future<bool> _checkHealthPermission() async {
    // 检查健康数据权限
    return await Permission.health.isGranted;
  }

  Future<AuthResult> _requestHuaweiHealthAuth() async {
    // 调用华为健康SDK
    // 这里是伪代码，实际需要集成华为HMS SDK
    return AuthResult(success: true, authCode: 'mock_auth_code');
  }
}

// 用药提醒管理用例
@riverpod
class MedicationReminderUseCase extends _$MedicationReminderUseCase {
  Future<Result<MedicationReminder, AppError>> createReminder(
    String patientId,
    String medicationName,
    String dosage,
    List<TimeOfDay> times,
    List<int> weekdays,
  ) async {
    // 验证输入
    if (medicationName.trim().isEmpty) {
      return const Result.failure(
        AppError.validation(field: 'medication', message: '请输入药品名称'),
      );
    }

    if (times.isEmpty) {
      return const Result.failure(
        AppError.validation(field: 'times', message: '请设置服药时间'),
      );
    }

    // 检查通知权限
    final hasPermission = await _checkNotificationPermission();
    if (!hasPermission) {
      return const Result.failure(
        AppError.validation(field: 'permission', message: '需要通知权限'),
      );
    }

    final reminder = MedicationReminder(
      id: '', // 服务器生成
      patientId: patientId,
      medicationName: medicationName,
      dosage: dosage,
      scheduledTimes: times,
      weekdays: weekdays,
      startDate: DateTime.now(),
      isActive: true,
      createdAt: DateTime.now(),
    );

    final repository = ref.read(profileRepositoryProvider);
    final result = await repository.createMedicationReminder(reminder);

    // 创建成功后设置本地通知
    result.whenSuccess((reminder) async {
      await _scheduleNotifications(reminder);
    });

    return result;
  }

  Future<bool> _checkNotificationPermission() async {
    return await Permission.notification.isGranted;
  }

  Future<void> _scheduleNotifications(MedicationReminder reminder) async {
    final flutterLocalNotificationsPlugin = FlutterLocalNotificationsPlugin();

    // 为每个时间点创建通知
    for (int i = 0; i < reminder.scheduledTimes.length; i++) {
      final time = reminder.scheduledTimes[i];

      await flutterLocalNotificationsPlugin.zonedSchedule(
        reminder.id.hashCode + i,
        '用药提醒',
        '该服用 ${reminder.medicationName} 了（${reminder.dosage}）',
        _nextInstanceOfTime(time),
        const NotificationDetails(
          android: AndroidNotificationDetails(
            'medication_reminder',
            '用药提醒',
            channelDescription: '提醒按时服药',
            importance: Importance.high,
            priority: Priority.high,
          ),
        ),
        androidAllowWhileIdle: true,
        uiLocalNotificationDateInterpretation: UILocalNotificationDateInterpretation.absoluteTime,
        matchDateTimeComponents: DateTimeComponents.time,
      );
    }
  }

  tz.TZDateTime _nextInstanceOfTime(TimeOfDay time) {
    final now = tz.TZDateTime.now(tz.local);
    var scheduledDate = tz.TZDateTime(
      tz.local,
      now.year,
      now.month,
      now.day,
      time.hour,
      time.minute,
    );

    if (scheduledDate.isBefore(now)) {
      scheduledDate = scheduledDate.add(const Duration(days: 1));
    }

    return scheduledDate;
  }
}
```

## 5. 表现层架构

### 5.1 状态管理

```dart
// 个人中心状态管理
@riverpod
class ProfileNotifier extends _$ProfileNotifier {
  @override
  AsyncValue<ProfileState> build() {
    _loadProfileData();
    return const AsyncValue.loading();
  }

  Future<void> refresh() async {
    await _loadProfileData(forceRefresh: true);
  }

  Future<void> updateProfile(UserProfile profile) async {
    final repository = ref.read(profileRepositoryProvider);
    final result = await repository.updateUserProfile(profile);

    result.when(
      success: (updatedProfile) {
        state.whenData((currentState) {
          state = AsyncValue.data(currentState.copyWith(
            userProfile: updatedProfile,
          ));
        });
      },
      failure: (error) {
        state.whenData((currentState) {
          state = AsyncValue.data(currentState.copyWith(
            error: error.toString(),
          ));
        });
      },
    );
  }

  Future<void> _loadProfileData({bool forceRefresh = false}) async {
    try {
      final futures = [
        ref.read(getUserProfileUseCaseProvider.notifier).execute(forceRefresh: forceRefresh),
        ref.read(profileRepositoryProvider).getConnectedDevices(),
        ref.read(profileRepositoryProvider).getMyServices(),
        ref.read(profileRepositoryProvider).getFavorites(),
        ref.read(profileRepositoryProvider).getAppSettings(),
      ];

      final results = await Future.wait(futures);

      state = AsyncValue.data(ProfileState(
        userProfile: results[0].success ? results[0].data : null,
        connectedDevices: results[1].success ? results[1].data : [],
        myServices: results[2].success ? results[2].data : [],
        favorites: results[3].success ? results[3].data : [],
        settings: results[4].success ? results[4].data : const AppSettings(),
      ));
    } catch (e) {
      state = AsyncValue.error(e, StackTrace.current);
    }
  }
}

// 设备管理状态
@riverpod
class DeviceManagementNotifier extends _$DeviceManagementNotifier {
  @override
  AsyncValue<DeviceManagementState> build() {
    _loadDevices();
    return const AsyncValue.loading();
  }

  Future<void> connectDevice(DeviceType deviceType) async {
    state.whenData((currentState) {
      state = AsyncValue.data(currentState.copyWith(
        isConnecting: true,
        connectingDeviceId: deviceType.name,
      ));
    });

    final useCase = ref.read(connectDeviceUseCaseProvider.notifier);
    final result = await useCase.execute(deviceType);

    result.when(
      success: (device) {
        state.whenData((currentState) {
          final updatedDevices = [...currentState.connectedDevices, device];
          state = AsyncValue.data(currentState.copyWith(
            connectedDevices: updatedDevices,
            isConnecting: false,
            connectingDeviceId: null,
          ));
        });
      },
      failure: (error) {
        state.whenData((currentState) {
          state = AsyncValue.data(currentState.copyWith(
            isConnecting: false,
            connectingDeviceId: null,
            error: error.toString(),
          ));
        });
      },
    );
  }

  Future<void> _loadDevices() async {
    final repository = ref.read(profileRepositoryProvider);
    final result = await repository.getConnectedDevices();

    result.when(
      success: (devices) {
        state = AsyncValue.data(DeviceManagementState(
          connectedDevices: devices,
          availableDevices: DeviceType.values,
        ));
      },
      failure: (error) {
        state = AsyncValue.error(error, StackTrace.current);
      },
    );
  }
}

// 应用设置状态
@riverpod
class AppSettingsNotifier extends _$AppSettingsNotifier {
  @override
  AsyncValue<AppSettings> build() {
    _loadSettings();
    return const AsyncValue.loading();
  }

  void updateSettings(AppSettings settings) {
    state = AsyncValue.data(settings);
    _saveSettings(settings);
  }

  void toggleNotifications(bool enabled) {
    state.whenData((currentSettings) {
      final updatedSettings = currentSettings.copyWith(notificationsEnabled: enabled);
      state = AsyncValue.data(updatedSettings);
      _saveSettings(updatedSettings);
    });
  }

  void changeTheme(ThemeMode themeMode) {
    state.whenData((currentSettings) {
      final updatedSettings = currentSettings.copyWith(themeMode: themeMode);
      state = AsyncValue.data(updatedSettings);
      _saveSettings(updatedSettings);
    });
  }

  Future<void> _loadSettings() async {
    final repository = ref.read(profileRepositoryProvider);
    final result = await repository.getAppSettings();

    result.when(
      success: (settings) => state = AsyncValue.data(settings),
      failure: (error) => state = AsyncValue.error(error, StackTrace.current),
    );
  }

  Future<void> _saveSettings(AppSettings settings) async {
    final repository = ref.read(profileRepositoryProvider);
    await repository.saveAppSettings(settings);
  }
}
```

### 5.2 UI 组件设计

```dart
// 个人中心主页面
class ProfileScreen extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final profileState = ref.watch(profileNotifierProvider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('个人中心'),
        actions: [
          IconButton(
            icon: const Icon(Icons.settings),
            onPressed: () => context.go('/profile/settings'),
          ),
        ],
      ),
      body: profileState.when(
        loading: () => const LoadingView(),
        error: (error, _) => ErrorView(error: error),
        data: (state) => _ProfileContent(state: state),
      ),
    );
  }
}

// 个人中心内容
class _ProfileContent extends StatelessWidget {
  const _ProfileContent({required this.state});

  final ProfileState state;

  @override
  Widget build(BuildContext context) {
    return ListView(
      children: [
        // 用户信息头部
        _UserInfoSection(userProfile: state.userProfile),

        const SizedBox(height: 16),

        // 快捷功能
        _QuickActionsSection(),

        const SizedBox(height: 16),

        // 功能列表
        _FunctionListSection(
          connectedDevices: state.connectedDevices,
          myServices: state.myServices,
        ),
      ],
    );
  }
}

// 用户信息区域
class _UserInfoSection extends StatelessWidget {
  const _UserInfoSection({this.userProfile});

  final UserProfile? userProfile;

  @override
  Widget build(BuildContext context) {
    if (userProfile == null) {
      return const Card(
        child: ListTile(
          title: Text('加载中...'),
        ),
      );
    }

    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Row(
          children: [
            // 头像
            CircleAvatar(
              radius: 30,
              backgroundImage: userProfile!.avatarUrl != null
                  ? NetworkImage(userProfile!.avatarUrl!)
                  : null,
              child: userProfile!.avatarUrl == null
                  ? Text(userProfile!.name[0])
                  : null,
            ),

            const SizedBox(width: 16),

            // 用户信息
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    userProfile!.name,
                    style: Theme.of(context).textTheme.titleLarge,
                  ),
                  const SizedBox(height: 4),
                  Text(
                    userProfile!.phone,
                    style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                      color: Theme.of(context).colorScheme.onSurfaceVariant,
                    ),
                  ),
                  if (userProfile!.age != null) ...[
                    const SizedBox(height: 4),
                    Text(
                      '${userProfile!.age}岁 · ${userProfile!.gender?.label ?? ''}',
                      style: Theme.of(context).textTheme.bodySmall?.copyWith(
                        color: Theme.of(context).colorScheme.onSurfaceVariant,
                      ),
                    ),
                  ],
                ],
              ),
            ),

            // 编辑按钮
            IconButton(
              icon: const Icon(Icons.edit),
              onPressed: () => context.go('/profile/edit'),
            ),
          ],
        ),
      ),
    );
  }
}

// 快捷功能区域
class _QuickActionsSection extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          children: [
            _QuickActionItem(
              icon: Icons.favorite,
              label: '我的收藏',
              onTap: () => context.go('/profile/favorites'),
            ),
            _QuickActionItem(
              icon: Icons.feedback,
              label: '健康反馈',
              onTap: () => context.go('/profile/feedback'),
            ),
          ],
        ),
      ),
    );
  }
}

// 快捷操作项
class _QuickActionItem extends StatelessWidget {
  const _QuickActionItem({
    required this.icon,
    required this.label,
    required this.onTap,
  });

  final IconData icon;
  final String label;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(8),
      child: Padding(
        padding: const EdgeInsets.all(12),
        child: Column(
          children: [
            Icon(icon, size: 32),
            const SizedBox(height: 8),
            Text(label, style: Theme.of(context).textTheme.bodyMedium),
          ],
        ),
      ),
    );
  }
}

// 功能列表区域
class _FunctionListSection extends StatelessWidget {
  const _FunctionListSection({
    required this.connectedDevices,
    required this.myServices,
  });

  final List<ConnectedDevice> connectedDevices;
  final List<MyService> myServices;

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        _buildListItem(
          context,
          icon: Icons.people,
          title: '就诊人管理',
          onTap: () => context.go('/profile/patients'),
        ),
        _buildListItem(
          context,
          icon: Icons.devices,
          title: '智能设备',
          subtitle: '${connectedDevices.length}个已连接',
          onTap: () => context.go('/profile/devices'),
        ),
        _buildListItem(
          context,
          icon: Icons.medical_services,
          title: '我的服务',
          subtitle: '${myServices.length}项服务',
          onTap: () => context.go('/profile/services'),
        ),
        _buildListItem(
          context,
          icon: Icons.assessment,
          title: '专项评估',
          onTap: () => context.go('/profile/assessments'),
        ),
        _buildListItem(
          context,
          icon: Icons.medication,
          title: '用药提醒',
          onTap: () => context.go('/profile/medication-reminders'),
        ),
        _buildListItem(
          context,
          icon: Icons.settings,
          title: '个人设置',
          onTap: () => context.go('/profile/settings'),
        ),
        _buildListItem(
          context,
          icon: Icons.info,
          title: '关于',
          onTap: () => context.go('/profile/about'),
        ),
      ],
    );
  }

  Widget _buildListItem(
    BuildContext context, {
    required IconData icon,
    required String title,
    String? subtitle,
    required VoidCallback onTap,
  }) {
    return Card(
      child: ListTile(
        leading: Icon(icon),
        title: Text(title),
        subtitle: subtitle != null ? Text(subtitle) : null,
        trailing: const Icon(Icons.chevron_right),
        onTap: onTap,
      ),
    );
  }
}

// 设备管理页面
class DeviceManagementScreen extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final deviceState = ref.watch(deviceManagementNotifierProvider);

    return Scaffold(
      appBar: AppBar(title: const Text('智能设备')),
      body: deviceState.when(
        loading: () => const LoadingView(),
        error: (error, _) => ErrorView(error: error),
        data: (state) => _DeviceManagementContent(state: state),
      ),
    );
  }
}

// 设备管理内容
class _DeviceManagementContent extends ConsumerWidget {
  const _DeviceManagementContent({required this.state});

  final DeviceManagementState state;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return ListView(
      padding: const EdgeInsets.all(16),
      children: [
        // 已连接设备
        if (state.connectedDevices.isNotEmpty) ...[
          Text(
            '已连接设备',
            style: Theme.of(context).textTheme.titleMedium,
          ),
          const SizedBox(height: 12),
          ...state.connectedDevices.map((device) => _ConnectedDeviceCard(device: device)),
          const SizedBox(height: 24),
        ],

        // 可连接设备
        Text(
          '可连接设备',
          style: Theme.of(context).textTheme.titleMedium,
        ),
        const SizedBox(height: 12),
        ...state.availableDevices.map((deviceType) {
          final isConnected = state.connectedDevices
              .any((device) => device.type == deviceType);

          if (isConnected) return const SizedBox.shrink();

          return _AvailableDeviceCard(
            deviceType: deviceType,
            isConnecting: state.isConnecting &&
                state.connectingDeviceId == deviceType.name,
            onConnect: () => ref
                .read(deviceManagementNotifierProvider.notifier)
                .connectDevice(deviceType),
          );
        }),
      ],
    );
  }
}

// 已连接设备卡片
class _ConnectedDeviceCard extends StatelessWidget {
  const _ConnectedDeviceCard({required this.device});

  final ConnectedDevice device;

  @override
  Widget build(BuildContext context) {
    return Card(
      child: ListTile(
        leading: Icon(device.type.icon),
        title: Text(device.name),
        subtitle: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(
                  Icons.circle,
                  size: 8,
                  color: device.status.color,
                ),
                const SizedBox(width: 4),
                Text(device.status.label),
              ],
            ),
            if (device.lastSync != null)
              Text('最后同步: ${_formatDateTime(device.lastSync!)}'),
          ],
        ),
        trailing: PopupMenuButton(
          itemBuilder: (context) => [
            const PopupMenuItem(
              value: 'sync',
              child: Text('立即同步'),
            ),
            const PopupMenuItem(
              value: 'disconnect',
              child: Text('断开连接'),
            ),
          ],
        ),
      ),
    );
  }

  String _formatDateTime(DateTime dateTime) {
    final now = DateTime.now();
    final difference = now.difference(dateTime);

    if (difference.inDays > 0) {
      return '${difference.inDays}天前';
    } else if (difference.inHours > 0) {
      return '${difference.inHours}小时前';
    } else {
      return '${difference.inMinutes}分钟前';
    }
  }
}
```

## 6. TDD 测试策略

### 6.1 核心测试用例

```dart
// 设备连接用例测试
void main() {
  group('ConnectDeviceUseCase', () {
    late ProviderContainer container;
    late MockProfileRepository mockRepository;

    setUp(() {
      mockRepository = MockProfileRepository();
      container = ProviderContainer(
        overrides: [
          profileRepositoryProvider.overrideWithValue(mockRepository),
        ],
      );
    });

    test('should connect Huawei Health successfully', () async {
      // Given
      final expectedDevice = ConnectedDevice(
        id: 'device_1',
        name: '华为运动健康',
        type: DeviceType.huaweiHealth,
        status: DeviceStatus.connected,
        connectedAt: DateTime.now(),
      );

      when(() => mockRepository.connectDevice(DeviceType.huaweiHealth, any()))
          .thenAnswer((_) async => Result.success(expectedDevice));

      // When
      final useCase = container.read(connectDeviceUseCaseProvider.notifier);
      final result = await useCase.execute(DeviceType.huaweiHealth);

      // Then
      expect(result.isSuccess, true);
      result.when(
        success: (device) {
          expect(device.name, '华为运动健康');
          expect(device.status, DeviceStatus.connected);
        },
        failure: (_) => fail('Expected success'),
      );
    });
  });
}

// 用药提醒测试
void main() {
  group('MedicationReminderUseCase', () {
    test('should validate medication name correctly', () async {
      // Given
      const patientId = 'patient_1';
      const emptyName = '';

      // When
      final container = ProviderContainer();
      final useCase = container.read(medicationReminderUseCaseProvider.notifier);
      final result = await useCase.createReminder(
        patientId,
        emptyName,
        '5mg',
        [const TimeOfDay(hour: 8, minute: 0)],
        [1, 2, 3, 4, 5],
      );

      // Then
      expect(result.isFailure, true);
      result.when(
        success: (_) => fail('Expected validation error'),
        failure: (error) {
          expect(error, isA<AppError>());
          error.maybeWhen(
            validation: (field, message) {
              expect(field, 'medication');
              expect(message, contains('药品名称'));
            },
            orElse: () => fail('Expected validation error'),
          );
        },
      );
    });
  });
}
```

## 7. 第三方集成

### 7.1 华为运动健康集成

```dart
// 华为健康数据同步服务
class HuaweiHealthService {
  static const MethodChannel _channel = MethodChannel('huawei_health');

  static Future<bool> isAvailable() async {
    try {
      return await _channel.invokeMethod('isAvailable');
    } catch (e) {
      return false;
    }
  }

  static Future<AuthResult> requestAuthorization() async {
    try {
      final result = await _channel.invokeMethod('requestAuth');
      return AuthResult.fromMap(result);
    } catch (e) {
      return AuthResult(success: false, error: e.toString());
    }
  }

  static Future<HealthData> syncHealthData() async {
    try {
      final result = await _channel.invokeMethod('syncData');
      return HealthData.fromMap(result);
    } catch (e) {
      throw Exception('健康数据同步失败: $e');
    }
  }
}
```

### 7.2 本地通知集成

```dart
// 通知服务
class NotificationService {
  static final FlutterLocalNotificationsPlugin _notifications =
      FlutterLocalNotificationsPlugin();

  static Future<void> initialize() async {
    const initializationSettingsAndroid = AndroidInitializationSettings('app_icon');
    const initializationSettingsIOS = DarwinInitializationSettings();

    const initializationSettings = InitializationSettings(
      android: initializationSettingsAndroid,
      iOS: initializationSettingsIOS,
    );

    await _notifications.initialize(initializationSettings);
  }

  static Future<void> scheduleMedicationReminder(
    MedicationReminder reminder,
  ) async {
    // 为每个时间点创建重复通知
    for (int i = 0; i < reminder.scheduledTimes.length; i++) {
      await _notifications.zonedSchedule(
        reminder.id.hashCode + i,
        '用药提醒',
        '该服用 ${reminder.medicationName} 了',
        _nextInstanceOfTime(reminder.scheduledTimes[i]),
        const NotificationDetails(
          android: AndroidNotificationDetails(
            'medication',
            '用药提醒',
            importance: Importance.high,
          ),
        ),
        androidAllowWhileIdle: true,
        uiLocalNotificationDateInterpretation:
            UILocalNotificationDateInterpretation.absoluteTime,
        matchDateTimeComponents: DateTimeComponents.time,
      );
    }
  }
}
```

这个个人中心模块架构设计涵盖了用户信息管理、设备连接、用药提醒、应用设置等完整功能，支持第三方设备集成和本地通知服务，为用户提供全面的个人账户管理体验。
