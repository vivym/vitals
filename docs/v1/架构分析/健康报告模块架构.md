# 健康报告模块架构设计

## 1. 模块概述

### 1.1 功能描述
健康报告模块提供专业的健康数据分析和康复进度报告，通过WebView加载网页版报告，支持报告查看、分享和管理功能。

### 1.2 核心功能
- **报告列表**: 展示患者的各类健康报告，按时间排序
- **报告查看**: 使用WebView加载网页版报告内容
- **报告分享**: 支持将报告链接分享给医生或家人
- **报告分类**: 康复月报、专项评估报告、健康分析报告等
- **离线缓存**: 支持报告内容的本地缓存
- **进度跟踪**: 报告生成状态和阅读进度管理

### 1.3 技术要求
- 基于TDD开发模式
- 使用webview_flutter组件
- 支持报告URL的安全验证
- 实现分享功能(share_plus)
- 优化WebView性能和用户体验

## 2. 数据模型设计

### 2.1 核心实体模型

```dart
// 健康报告
@freezed
class HealthReport with _$HealthReport {
  const factory HealthReport({
    required String id,
    required String patientId,
    required String title,
    required String description,
    required ReportType type,
    required String reportUrl,
    required ReportStatus status,
    @JsonKey(name: 'generated_at') DateTime? generatedAt,
    @JsonKey(name: 'period_start') DateTime? periodStart,
    @JsonKey(name: 'period_end') DateTime? periodEnd,
    String? thumbnailUrl,
    @Default(false) bool isRead,
    @Default(false) bool isShared,
    @JsonKey(name: 'created_at') DateTime? createdAt,
    Map<String, dynamic>? metadata,
  }) = _HealthReport;

  factory HealthReport.fromJson(Map<String, dynamic> json) =>
      _$HealthReportFromJson(json);

  const HealthReport._();

  String get periodDescription {
    if (periodStart == null || periodEnd == null) return '';

    final start = DateFormat('yyyy年MM月dd日').format(periodStart!);
    final end = DateFormat('yyyy年MM月dd日').format(periodEnd!);
    return '$start - $end';
  }

  String get formattedGeneratedDate {
    if (generatedAt == null) return '';
    return DateFormat('yyyy年MM月dd日').format(generatedAt!);
  }

  bool get isExpired {
    if (generatedAt == null) return false;
    // 报告有效期为90天
    return DateTime.now().difference(generatedAt!).inDays > 90;
  }
}

// 报告类型
@JsonEnum(valueField: 'value')
enum ReportType {
  recoveryMonthly(1, 'PCI术后康复月报', Icons.calendar_month, Color(0xFF2196F3)),
  healthAssessment(2, '健康评估报告', Icons.assessment, Color(0xFF4CAF50)),
  medicationAnalysis(3, '用药分析报告', Icons.medication, Color(0xFFFF9800)),
  lifestyleReport(4, '生活方式报告', Icons.lifestyle, Color(0xFF9C27B0)),
  riskAssessment(5, '风险评估报告', Icons.warning, Color(0xFFFF5722));

  const ReportType(this.value, this.label, this.icon, this.color);
  final int value;
  final String label;
  final IconData icon;
  final Color color;
}

// 报告状态
@JsonEnum(valueField: 'value')
enum ReportStatus {
  generating(1, '生成中', Color(0xFFFF9800)),
  ready(2, '已生成', Color(0xFF4CAF50)),
  failed(3, '生成失败', Color(0xFFFF5722)),
  expired(4, '已过期', Color(0xFF9E9E9E));

  const ReportStatus(this.value, this.label, this.color);
  final int value;
  final String label;
  final Color color;
}

// 报告分享记录
@freezed
class ReportShareRecord with _$ReportShareRecord {
  const factory ReportShareRecord({
    required String id,
    required String reportId,
    required ShareMethod method,
    String? recipientInfo,
    @JsonKey(name: 'shared_at') required DateTime sharedAt,
    String? message,
  }) = _ReportShareRecord;

  factory ReportShareRecord.fromJson(Map<String, dynamic> json) =>
      _$ReportShareRecordFromJson(json);
}

// 分享方式
@JsonEnum(valueField: 'value')
enum ShareMethod {
  link(1, '复制链接'),
  wechat(2, '微信分享'),
  email(3, '邮件发送'),
  sms(4, '短信发送'),
  qrcode(5, '二维码分享');

  const ShareMethod(this.value, this.label);
  final int value;
  final String label;
}

// WebView 状态
@freezed
class WebViewState with _$WebViewState {
  const factory WebViewState({
    @Default(false) bool isLoading,
    @Default(false) bool hasError,
    String? errorMessage,
    @Default(0) int loadProgress,
    String? currentUrl,
    @Default(false) bool canGoBack,
    @Default(false) bool canGoForward,
  }) = _WebViewState;
}
```

### 2.2 状态模型

```dart
// 报告列表状态
@freezed
class ReportsState with _$ReportsState {
  const factory ReportsState({
    @Default([]) List<HealthReport> reports,
    @Default(ReportType.recoveryMonthly) ReportType selectedType,
    @Default(false) bool isLoading,
    @Default(false) bool isRefreshing,
    String? error,
    @JsonKey(name: 'last_updated') DateTime? lastUpdated,
  }) = _ReportsState;

  const ReportsState._();

  List<HealthReport> get filteredReports =>
      reports.where((report) => report.type == selectedType).toList();

  List<HealthReport> get readyReports =>
      reports.where((report) => report.status == ReportStatus.ready).toList();

  List<HealthReport> get unreadReports =>
      readyReports.where((report) => !report.isRead).toList();
}

// 报告详情状态
@freezed
class ReportDetailState with _$ReportDetailState {
  const factory ReportDetailState({
    HealthReport? report,
    @Default(WebViewState()) WebViewState webViewState,
    @Default(false) bool isSharing,
    String? shareError,
    @Default([]) List<ReportShareRecord> shareHistory,
  }) = _ReportDetailState;
}
```

## 3. 数据层架构

### 3.1 数据源设计

```dart
// 报告远程数据源
abstract class ReportsRemoteDataSource {
  Future<List<HealthReport>> getReports(String patientId);
  Future<HealthReport> getReportById(String reportId);
  Future<void> markReportAsRead(String reportId);
  Future<String> generateShareLink(String reportId);
  Future<void> recordShare(String reportId, ShareMethod method, String? recipientInfo);
  Future<void> requestReportGeneration(String patientId, ReportType type);
}

// Mock 实现
class ReportsRemoteDataSourceMock implements ReportsRemoteDataSource {
  @override
  Future<List<HealthReport>> getReports(String patientId) async {
    await Future.delayed(const Duration(milliseconds: 800));

    return [
      HealthReport(
        id: 'report_1',
        patientId: patientId,
        title: 'PCI术后康复月报',
        description: '2024年1月康复进展分析报告',
        type: ReportType.recoveryMonthly,
        reportUrl: 'https://vitals.example.com/reports/recovery-202401',
        status: ReportStatus.ready,
        generatedAt: DateTime.now().subtract(const Duration(days: 5)),
        periodStart: DateTime(2024, 1, 1),
        periodEnd: DateTime(2024, 1, 31),
        isRead: false,
        isShared: false,
        createdAt: DateTime.now().subtract(const Duration(days: 5)),
      ),
      HealthReport(
        id: 'report_2',
        patientId: patientId,
        title: '健康评估报告',
        description: '综合健康状况评估与建议',
        type: ReportType.healthAssessment,
        reportUrl: 'https://vitals.example.com/reports/assessment-202401',
        status: ReportStatus.ready,
        generatedAt: DateTime.now().subtract(const Duration(days: 10)),
        isRead: true,
        isShared: true,
        createdAt: DateTime.now().subtract(const Duration(days: 10)),
      ),
      HealthReport(
        id: 'report_3',
        patientId: patientId,
        title: '2月份康复月报',
        description: '生成中，预计5分钟后完成',
        type: ReportType.recoveryMonthly,
        reportUrl: '',
        status: ReportStatus.generating,
        createdAt: DateTime.now().subtract(const Duration(minutes: 2)),
      ),
    ];
  }

  @override
  Future<String> generateShareLink(String reportId) async {
    await Future.delayed(const Duration(milliseconds: 300));
    return 'https://vitals.example.com/shared/reports/$reportId?token=share_token_123';
  }

  @override
  Future<void> recordShare(String reportId, ShareMethod method, String? recipientInfo) async {
    await Future.delayed(const Duration(milliseconds: 200));
    // Mock 记录分享行为
  }
}

// 本地数据源
class ReportsLocalDataSourceImpl implements ReportsLocalDataSource {
  final SharedPreferences _prefs;

  @override
  Future<List<HealthReport>?> getCachedReports(String patientId) async {
    final key = 'reports_$patientId';
    final jsonString = _prefs.getString(key);

    if (jsonString != null) {
      final List<dynamic> jsonList = jsonDecode(jsonString);
      return jsonList.map((json) => HealthReport.fromJson(json)).toList();
    }

    return null;
  }

  @override
  Future<void> cacheReports(String patientId, List<HealthReport> reports) async {
    final key = 'reports_$patientId';
    final jsonString = jsonEncode(reports.map((r) => r.toJson()).toList());
    await _prefs.setString(key, jsonString);
  }

  @override
  Future<List<String>> getReadReportIds() async {
    return _prefs.getStringList('read_report_ids') ?? [];
  }

  @override
  Future<void> markReportAsRead(String reportId) async {
    final readIds = await getReadReportIds();
    if (!readIds.contains(reportId)) {
      readIds.add(reportId);
      await _prefs.setStringList('read_report_ids', readIds);
    }
  }
}
```

### 3.2 仓库实现

```dart
// 报告仓库
class ReportsRepositoryImpl implements ReportsRepository {
  final ReportsRemoteDataSource _remoteDataSource;
  final ReportsLocalDataSource _localDataSource;

  @override
  Future<Result<List<HealthReport>, AppError>> getReports(
    String patientId, {
    bool forceRefresh = false,
  }) async {
    try {
      // 离线优先策略
      if (!forceRefresh) {
        final cachedReports = await _localDataSource.getCachedReports(patientId);
        if (cachedReports != null && cachedReports.isNotEmpty) {
          // 合并本地阅读状态
          final updatedReports = await _mergeReadStatus(cachedReports);
          return Result.success(updatedReports);
        }
      }

      // 获取远程数据
      final remoteReports = await _remoteDataSource.getReports(patientId);
      final updatedReports = await _mergeReadStatus(remoteReports);

      // 缓存数据
      await _localDataSource.cacheReports(patientId, updatedReports);

      return Result.success(updatedReports);
    } catch (e) {
      // 网络错误时尝试返回缓存
      final cachedReports = await _localDataSource.getCachedReports(patientId);
      if (cachedReports != null) {
        final updatedReports = await _mergeReadStatus(cachedReports);
        return Result.success(updatedReports);
      }

      return Result.failure(AppError.network(message: e.toString()));
    }
  }

  @override
  Future<Result<void, AppError>> markReportAsRead(String reportId) async {
    try {
      // 先更新本地状态
      await _localDataSource.markReportAsRead(reportId);

      // 同步到服务器
      await _remoteDataSource.markReportAsRead(reportId);

      return const Result.success(null);
    } catch (e) {
      return Result.failure(AppError.network(message: e.toString()));
    }
  }

  @override
  Future<Result<String, AppError>> shareReport(
    String reportId,
    ShareMethod method, {
    String? recipientInfo,
  }) async {
    try {
      final shareLink = await _remoteDataSource.generateShareLink(reportId);

      // 记录分享行为
      await _remoteDataSource.recordShare(reportId, method, recipientInfo);

      return Result.success(shareLink);
    } catch (e) {
      return Result.failure(AppError.network(message: e.toString()));
    }
  }

  Future<List<HealthReport>> _mergeReadStatus(List<HealthReport> reports) async {
    final readIds = await _localDataSource.getReadReportIds();

    return reports.map((report) {
      return report.copyWith(isRead: readIds.contains(report.id));
    }).toList();
  }
}
```

## 4. 业务逻辑层

### 4.1 用例定义

```dart
// 获取报告列表用例
@riverpod
class GetReportsUseCase extends _$GetReportsUseCase {
  Future<Result<List<HealthReport>, AppError>> execute(
    String patientId, {
    bool forceRefresh = false,
  }) async {
    final repository = ref.read(reportsRepositoryProvider);
    return await repository.getReports(patientId, forceRefresh: forceRefresh);
  }
}

// 报告分享用例
@riverpod
class ShareReportUseCase extends _$ShareReportUseCase {
  Future<Result<void, AppError>> execute(
    String reportId,
    ShareMethod method, {
    String? customMessage,
  }) async {
    final repository = ref.read(reportsRepositoryProvider);

    // 生成分享链接
    final shareResult = await repository.shareReport(reportId, method);

    return shareResult.when(
      success: (shareLink) async {
        // 执行实际分享操作
        return await _performShare(shareLink, method, customMessage);
      },
      failure: (error) => Result.failure(error),
    );
  }

  Future<Result<void, AppError>> _performShare(
    String shareLink,
    ShareMethod method,
    String? customMessage,
  ) async {
    try {
      switch (method) {
        case ShareMethod.link:
          await Clipboard.setData(ClipboardData(text: shareLink));
          break;

        case ShareMethod.wechat:
        case ShareMethod.email:
        case ShareMethod.sms:
          final message = customMessage ?? '我想与您分享我的健康报告';
          await Share.share('$message\n\n查看报告：$shareLink');
          break;

        case ShareMethod.qrcode:
          // 生成二维码逻辑
          break;
      }

      return const Result.success(null);
    } catch (e) {
      return Result.failure(AppError.unknown(message: '分享失败: $e'));
    }
  }
}

// 报告验证用例
@riverpod
class ValidateReportUrlUseCase extends _$ValidateReportUrlUseCase {
  bool execute(String url) {
    // URL安全验证
    final uri = Uri.tryParse(url);
    if (uri == null) return false;

    // 检查是否为HTTPS
    if (uri.scheme != 'https') return false;

    // 检查域名白名单
    const allowedHosts = [
      'vitals.example.com',
      'reports.vitals.example.com',
    ];

    return allowedHosts.contains(uri.host);
  }
}
```

## 5. 表现层架构

### 5.1 状态管理

```dart
// 报告列表状态管理
@riverpod
class ReportsNotifier extends _$ReportsNotifier {
  @override
  AsyncValue<ReportsState> build() {
    _loadReports();
    return const AsyncValue.loading();
  }

  Future<void> refresh() async {
    await _loadReports(forceRefresh: true);
  }

  void changeReportType(ReportType type) {
    state.whenData((currentState) {
      state = AsyncValue.data(currentState.copyWith(selectedType: type));
    });
  }

  Future<void> markAsRead(String reportId) async {
    final repository = ref.read(reportsRepositoryProvider);
    await repository.markReportAsRead(reportId);

    // 乐观更新UI
    state.whenData((currentState) {
      final updatedReports = currentState.reports.map((report) {
        if (report.id == reportId) {
          return report.copyWith(isRead: true);
        }
        return report;
      }).toList();

      state = AsyncValue.data(currentState.copyWith(reports: updatedReports));
    });
  }

  Future<void> _loadReports({bool forceRefresh = false}) async {
    final patients = ref.read(currentPatientsProvider);
    if (patients.isEmpty) return;

    final patientId = patients.first.id;
    final useCase = ref.read(getReportsUseCaseProvider.notifier);

    final result = await useCase.execute(patientId, forceRefresh: forceRefresh);

    result.when(
      success: (reports) {
        state = AsyncValue.data(ReportsState(
          reports: reports,
          lastUpdated: DateTime.now(),
        ));
      },
      failure: (error) {
        state = AsyncValue.error(error, StackTrace.current);
      },
    );
  }
}

// 报告详情状态管理
@riverpod
class ReportDetailNotifier extends _$ReportDetailNotifier {
  @override
  ReportDetailState build(String reportId) {
    _loadReportDetail(reportId);
    return const ReportDetailState();
  }

  void updateWebViewState(WebViewState webViewState) {
    state = state.copyWith(webViewState: webViewState);
  }

  Future<void> shareReport(ShareMethod method, {String? message}) async {
    state = state.copyWith(isSharing: true, shareError: null);

    final useCase = ref.read(shareReportUseCaseProvider.notifier);
    final result = await useCase.execute(
      state.report!.id,
      method,
      customMessage: message,
    );

    result.when(
      success: (_) {
        state = state.copyWith(isSharing: false);
        // 显示分享成功提示
      },
      failure: (error) {
        state = state.copyWith(
          isSharing: false,
          shareError: error.toString(),
        );
      },
    );
  }

  void _loadReportDetail(String reportId) {
    final reports = ref.read(reportsNotifierProvider).valueOrNull?.reports ?? [];
    final report = reports.firstWhereOrNull((r) => r.id == reportId);

    if (report != null) {
      state = state.copyWith(report: report);
    }
  }
}

// WebView控制器状态
@riverpod
class WebViewControllerNotifier extends _$WebViewControllerNotifier {
  WebViewController? _controller;

  @override
  WebViewState build() => const WebViewState();

  void setController(WebViewController controller) {
    _controller = controller;
  }

  void updateLoadingProgress(int progress) {
    state = state.copyWith(loadProgress: progress);
  }

  void updateLoadingState(bool isLoading) {
    state = state.copyWith(isLoading: isLoading);
  }

  void updateNavigationState(bool canGoBack, bool canGoForward) {
    state = state.copyWith(
      canGoBack: canGoBack,
      canGoForward: canGoForward,
    );
  }

  void setError(String error) {
    state = state.copyWith(hasError: true, errorMessage: error);
  }

  void clearError() {
    state = state.copyWith(hasError: false, errorMessage: null);
  }

  Future<void> reload() async {
    await _controller?.reload();
  }

  Future<void> goBack() async {
    if (state.canGoBack) {
      await _controller?.goBack();
    }
  }

  Future<void> goForward() async {
    if (state.canGoForward) {
      await _controller?.goForward();
    }
  }
}
```

### 5.2 UI 组件设计

```dart
// 报告列表页面
class ReportsScreen extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final reportsState = ref.watch(reportsNotifierProvider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('健康报告'),
        actions: [
          IconButton(
            icon: const Icon(Icons.refresh),
            onPressed: () => ref.read(reportsNotifierProvider.notifier).refresh(),
          ),
        ],
      ),
      body: Column(
        children: [
          // 报告类型选择器
          _ReportTypeSelector(),

          // 报告列表
          Expanded(
            child: reportsState.when(
              loading: () => const LoadingView(),
              error: (error, _) => ErrorView(error: error),
              data: (state) => _ReportsContent(state: state),
            ),
          ),
        ],
      ),
    );
  }
}

// 报告类型选择器
class _ReportTypeSelector extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final currentType = ref.watch(
      reportsNotifierProvider.select((state) =>
        state.valueOrNull?.selectedType ?? ReportType.recoveryMonthly),
    );

    return Container(
      height: 60,
      padding: const EdgeInsets.symmetric(horizontal: 16),
      child: ListView.builder(
        scrollDirection: Axis.horizontal,
        itemCount: ReportType.values.length,
        itemBuilder: (context, index) {
          final type = ReportType.values[index];
          final isSelected = type == currentType;

          return Padding(
            padding: const EdgeInsets.only(right: 12),
            child: FilterChip(
              label: Text(type.label),
              avatar: Icon(type.icon, size: 16),
              selected: isSelected,
              onSelected: (selected) {
                if (selected) {
                  ref.read(reportsNotifierProvider.notifier).changeReportType(type);
                }
              },
            ),
          );
        },
      ),
    );
  }
}

// 报告列表内容
class _ReportsContent extends ConsumerWidget {
  const _ReportsContent({required this.state});

  final ReportsState state;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final filteredReports = state.filteredReports;

    if (filteredReports.isEmpty) {
      return const EmptyStateView(
        icon: Icons.description,
        title: '暂无报告',
        subtitle: '该类型的报告还在生成中，请稍后查看',
      );
    }

    return RefreshIndicator(
      onRefresh: () => ref.read(reportsNotifierProvider.notifier).refresh(),
      child: ListView.builder(
        padding: const EdgeInsets.all(16),
        itemCount: filteredReports.length,
        itemBuilder: (context, index) {
          final report = filteredReports[index];
          return _ReportCard(
            report: report,
            onTap: () => _openReport(context, ref, report),
          );
        },
      ),
    );
  }

  void _openReport(BuildContext context, WidgetRef ref, HealthReport report) {
    if (report.status != ReportStatus.ready) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('报告${report.status.label}，暂时无法查看')),
      );
      return;
    }

    // 标记为已读
    if (!report.isRead) {
      ref.read(reportsNotifierProvider.notifier).markAsRead(report.id);
    }

    // 跳转到报告详情页
    context.go('/reports/${report.id}');
  }
}

// 报告卡片
class _ReportCard extends StatelessWidget {
  const _ReportCard({
    required this.report,
    required this.onTap,
  });

  final HealthReport report;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return Card(
      margin: const EdgeInsets.only(bottom: 12),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12),
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  // 报告类型图标
                  Container(
                    width: 40,
                    height: 40,
                    decoration: BoxDecoration(
                      color: report.type.color.withOpacity(0.1),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Icon(
                      report.type.icon,
                      color: report.type.color,
                      size: 20,
                    ),
                  ),

                  const SizedBox(width: 12),

                  // 报告信息
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          children: [
                            Expanded(
                              child: Text(
                                report.title,
                                style: Theme.of(context).textTheme.titleMedium?.copyWith(
                                  fontWeight: report.isRead ? FontWeight.normal : FontWeight.bold,
                                ),
                              ),
                            ),
                            if (!report.isRead)
                              Container(
                                width: 8,
                                height: 8,
                                decoration: BoxDecoration(
                                  color: Theme.of(context).primaryColor,
                                  shape: BoxShape.circle,
                                ),
                              ),
                          ],
                        ),
                        const SizedBox(height: 4),
                        Text(
                          report.description,
                          style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                            color: Theme.of(context).colorScheme.onSurfaceVariant,
                          ),
                        ),
                      ],
                    ),
                  ),

                  // 状态指示器
                  _ReportStatusIndicator(status: report.status),
                ],
              ),

              const SizedBox(height: 12),

              // 报告详情
              Row(
                children: [
                  if (report.periodDescription.isNotEmpty) ...[
                    Icon(
                      Icons.date_range,
                      size: 16,
                      color: Theme.of(context).colorScheme.onSurfaceVariant,
                    ),
                    const SizedBox(width: 4),
                    Text(
                      report.periodDescription,
                      style: Theme.of(context).textTheme.bodySmall,
                    ),
                    const SizedBox(width: 16),
                  ],

                  Icon(
                    Icons.access_time,
                    size: 16,
                    color: Theme.of(context).colorScheme.onSurfaceVariant,
                  ),
                  const SizedBox(width: 4),
                  Text(
                    report.formattedGeneratedDate,
                    style: Theme.of(context).textTheme.bodySmall,
                  ),

                  const Spacer(),

                  if (report.isShared) ...[
                    Icon(
                      Icons.share,
                      size: 16,
                      color: Theme.of(context).colorScheme.primary,
                    ),
                    const SizedBox(width: 4),
                    Text(
                      '已分享',
                      style: Theme.of(context).textTheme.bodySmall?.copyWith(
                        color: Theme.of(context).colorScheme.primary,
                      ),
                    ),
                  ],
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// 报告详情页面
class ReportDetailScreen extends ConsumerStatefulWidget {
  const ReportDetailScreen({super.key, required this.reportId});

  final String reportId;

  @override
  ConsumerState<ReportDetailScreen> createState() => _ReportDetailScreenState();
}

class _ReportDetailScreenState extends ConsumerState<ReportDetailScreen> {
  late WebViewController _webViewController;

  @override
  Widget build(BuildContext context) {
    final detailState = ref.watch(reportDetailNotifierProvider(widget.reportId));
    final webViewState = ref.watch(webViewControllerNotifierProvider);

    if (detailState.report == null) {
      return const Scaffold(
        body: Center(child: CircularProgressIndicator()),
      );
    }

    return Scaffold(
      appBar: AppBar(
        title: Text(detailState.report!.title),
        actions: [
          // 分享按钮
          IconButton(
            icon: const Icon(Icons.share),
            onPressed: () => _showShareDialog(context),
          ),

          // WebView控制按钮
          PopupMenuButton<String>(
            itemBuilder: (context) => [
              const PopupMenuItem(value: 'refresh', child: Text('刷新')),
              if (webViewState.canGoBack)
                const PopupMenuItem(value: 'back', child: Text('后退')),
              if (webViewState.canGoForward)
                const PopupMenuItem(value: 'forward', child: Text('前进')),
            ],
            onSelected: (value) => _handleWebViewAction(value),
          ),
        ],
      ),
      body: Column(
        children: [
          // 加载进度条
          if (webViewState.isLoading)
            LinearProgressIndicator(value: webViewState.loadProgress / 100),

          // WebView内容
          Expanded(
            child: webViewState.hasError
                ? _WebViewErrorView(
                    error: webViewState.errorMessage!,
                    onRetry: () => ref
                        .read(webViewControllerNotifierProvider.notifier)
                        .reload(),
                  )
                : _ReportWebView(
                    report: detailState.report!,
                    onWebViewCreated: (controller) {
                      _webViewController = controller;
                      ref
                          .read(webViewControllerNotifierProvider.notifier)
                          .setController(controller);
                    },
                  ),
          ),
        ],
      ),
    );
  }

  void _handleWebViewAction(String action) {
    final notifier = ref.read(webViewControllerNotifierProvider.notifier);

    switch (action) {
      case 'refresh':
        notifier.reload();
        break;
      case 'back':
        notifier.goBack();
        break;
      case 'forward':
        notifier.goForward();
        break;
    }
  }

  void _showShareDialog(BuildContext context) {
    showModalBottomSheet(
      context: context,
      builder: (context) => ReportShareDialog(
        reportId: widget.reportId,
        reportTitle: ref.read(reportDetailNotifierProvider(widget.reportId)).report!.title,
      ),
    );
  }
}

// 报告WebView组件
class _ReportWebView extends ConsumerStatefulWidget {
  const _ReportWebView({
    required this.report,
    required this.onWebViewCreated,
  });

  final HealthReport report;
  final Function(WebViewController) onWebViewCreated;

  @override
  ConsumerState<_ReportWebView> createState() => _ReportWebViewState();
}

class _ReportWebViewState extends ConsumerState<_ReportWebView> {
  @override
  Widget build(BuildContext context) {
    // 验证URL安全性
    final validateUseCase = ref.read(validateReportUrlUseCaseProvider.notifier);
    if (!validateUseCase.execute(widget.report.reportUrl)) {
      return const Center(
        child: Text('报告链接不安全，无法加载'),
      );
    }

    return WebView(
      initialUrl: widget.report.reportUrl,
      javascriptMode: JavascriptMode.restricted,
      onWebViewCreated: widget.onWebViewCreated,
      onPageStarted: (url) {
        ref.read(webViewControllerNotifierProvider.notifier)
            .updateLoadingState(true);
      },
      onPageFinished: (url) {
        ref.read(webViewControllerNotifierProvider.notifier)
            .updateLoadingState(false);
      },
      onProgress: (progress) {
        ref.read(webViewControllerNotifierProvider.notifier)
            .updateLoadingProgress(progress);
      },
      onWebResourceError: (error) {
        ref.read(webViewControllerNotifierProvider.notifier)
            .setError(error.description);
      },
      navigationDelegate: (request) {
        // 限制导航只在报告域名内
        final validateUseCase = ref.read(validateReportUrlUseCaseProvider.notifier);
        return validateUseCase.execute(request.url)
            ? NavigationDecision.navigate
            : NavigationDecision.prevent;
      },
    );
  }
}

// 分享对话框
class ReportShareDialog extends ConsumerWidget {
  const ReportShareDialog({
    super.key,
    required this.reportId,
    required this.reportTitle,
  });

  final String reportId;
  final String reportTitle;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final detailState = ref.watch(reportDetailNotifierProvider(reportId));

    return Container(
      padding: const EdgeInsets.all(24),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(
            '分享报告',
            style: Theme.of(context).textTheme.titleLarge,
          ),
          const SizedBox(height: 16),
          Text(
            reportTitle,
            style: Theme.of(context).textTheme.bodyMedium,
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 24),

          // 分享方式选择
          Wrap(
            spacing: 16,
            runSpacing: 16,
            children: ShareMethod.values.map((method) {
              return _ShareMethodButton(
                method: method,
                onPressed: detailState.isSharing
                    ? null
                    : () => _shareReport(context, ref, method),
              );
            }).toList(),
          ),

          if (detailState.shareError != null) ...[
            const SizedBox(height: 16),
            Text(
              detailState.shareError!,
              style: TextStyle(
                color: Theme.of(context).colorScheme.error,
              ),
            ),
          ],

          if (detailState.isSharing) ...[
            const SizedBox(height: 16),
            const CircularProgressIndicator(),
          ],
        ],
      ),
    );
  }

  void _shareReport(BuildContext context, WidgetRef ref, ShareMethod method) async {
    await ref
        .read(reportDetailNotifierProvider(reportId).notifier)
        .shareReport(method);

    if (context.mounted) {
      Navigator.of(context).pop();

      if (method == ShareMethod.link) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('链接已复制到剪贴板')),
        );
      }
    }
  }
}
```

## 6. TDD 测试策略

### 6.1 核心测试用例

```dart
// 报告分享用例测试
void main() {
  group('ShareReportUseCase', () {
    late ProviderContainer container;
    late MockReportsRepository mockRepository;

    setUp(() {
      mockRepository = MockReportsRepository();
      container = ProviderContainer(
        overrides: [
          reportsRepositoryProvider.overrideWithValue(mockRepository),
        ],
      );
    });

    test('should generate share link and copy to clipboard', () async {
      // Given
      const reportId = 'report_1';
      const shareLink = 'https://vitals.example.com/shared/reports/report_1';

      when(() => mockRepository.shareReport(reportId, ShareMethod.link))
          .thenAnswer((_) async => Result.success(shareLink));

      // When
      final useCase = container.read(shareReportUseCaseProvider.notifier);
      final result = await useCase.execute(reportId, ShareMethod.link);

      // Then
      expect(result.isSuccess, true);
      verify(() => mockRepository.shareReport(reportId, ShareMethod.link)).called(1);
    });
  });
}

// WebView状态管理测试
void main() {
  group('WebViewControllerNotifier', () {
    test('should update loading progress correctly', () {
      // Given
      final container = ProviderContainer();
      final notifier = container.read(webViewControllerNotifierProvider.notifier);

      // When
      notifier.updateLoadingProgress(50);

      // Then
      final state = container.read(webViewControllerNotifierProvider);
      expect(state.loadProgress, 50);
    });

    test('should handle navigation state correctly', () {
      // Given
      final container = ProviderContainer();
      final notifier = container.read(webViewControllerNotifierProvider.notifier);

      // When
      notifier.updateNavigationState(true, false);

      // Then
      final state = container.read(webViewControllerNotifierProvider);
      expect(state.canGoBack, true);
      expect(state.canGoForward, false);
    });
  });
}

// URL验证测试
void main() {
  group('ValidateReportUrlUseCase', () {
    test('should validate HTTPS URLs correctly', () {
      // Given
      final container = ProviderContainer();
      final useCase = container.read(validateReportUrlUseCaseProvider.notifier);

      // When & Then
      expect(useCase.execute('https://vitals.example.com/report/123'), true);
      expect(useCase.execute('http://vitals.example.com/report/123'), false);
      expect(useCase.execute('https://malicious.com/report/123'), false);
      expect(useCase.execute('invalid-url'), false);
    });
  });
}
```

## 7. 安全和性能考虑

### 7.1 WebView安全配置

```dart
// WebView安全配置
class SecureWebViewConfig {
  static WebView createSecureWebView({
    required String url,
    required Function(WebViewController) onWebViewCreated,
    Function(String)? onPageStarted,
    Function(String)? onPageFinished,
  }) {
    return WebView(
      initialUrl: url,
      // 限制JavaScript功能
      javascriptMode: JavascriptMode.restricted,

      // 禁用调试
      debuggingEnabled: false,

      // 安全导航控制
      navigationDelegate: (NavigationRequest request) {
        return _validateNavigation(request.url);
      },

      // 用户代理标识
      userAgent: 'VitalsApp/1.0',

      onWebViewCreated: onWebViewCreated,
      onPageStarted: onPageStarted,
      onPageFinished: onPageFinished,

      // 错误处理
      onWebResourceError: (WebResourceError error) {
        Logger.error('WebView error: ${error.description}');
      },
    );
  }

  static NavigationDecision _validateNavigation(String url) {
    final uri = Uri.tryParse(url);
    if (uri == null) return NavigationDecision.prevent;

    // 只允许HTTPS
    if (uri.scheme != 'https') return NavigationDecision.prevent;

    // 域名白名单检查
    const allowedDomains = [
      'vitals.example.com',
      'reports.vitals.example.com',
    ];

    return allowedDomains.contains(uri.host)
        ? NavigationDecision.navigate
        : NavigationDecision.prevent;
  }
}
```

### 7.2 缓存策略优化

```dart
// 报告缓存管理
class ReportCacheManager {
  static const Duration cacheExpiration = Duration(hours: 24);
  static const int maxCacheSize = 50; // 最多缓存50个报告

  static Future<void> cleanupExpiredCache() async {
    final prefs = await SharedPreferences.getInstance();
    final cacheKeys = prefs.getKeys()
        .where((key) => key.startsWith('report_cache_'))
        .toList();

    for (final key in cacheKeys) {
      final cacheData = prefs.getString(key);
      if (cacheData != null) {
        final data = jsonDecode(cacheData);
        final cachedAt = DateTime.fromMillisecondsSinceEpoch(data['cached_at']);

        if (DateTime.now().difference(cachedAt) > cacheExpiration) {
          await prefs.remove(key);
        }
      }
    }
  }

  static Future<void> limitCacheSize() async {
    final prefs = await SharedPreferences.getInstance();
    final cacheKeys = prefs.getKeys()
        .where((key) => key.startsWith('report_cache_'))
        .toList();

    if (cacheKeys.length > maxCacheSize) {
      // 按时间排序，删除最旧的缓存
      final sortedKeys = cacheKeys..sort((a, b) {
        final aData = jsonDecode(prefs.getString(a)!);
        final bData = jsonDecode(prefs.getString(b)!);
        final aTime = DateTime.fromMillisecondsSinceEpoch(aData['cached_at']);
        final bTime = DateTime.fromMillisecondsSinceEpoch(bData['cached_at']);
        return aTime.compareTo(bTime);
      });

      final keysToDelete = sortedKeys.take(sortedKeys.length - maxCacheSize);
      for (final key in keysToDelete) {
        await prefs.remove(key);
      }
    }
  }
}
```

这个健康报告模块架构设计完整实现了基于WebView的报告查看、分享功能，具备完善的安全验证、缓存管理和用户体验优化，为用户提供了专业的健康报告服务。

<function_calls>
<invoke name="todo_write">
<parameter name="merge">true
